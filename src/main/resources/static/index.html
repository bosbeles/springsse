<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<h1>Channel to be updated</h1>
<div id="result"></div>

<br>
<hr>
<br>

<p>Partial Refresh</p>
<div id="notification">


</div>

<br>
<hr>
<br>
<p>Clean Refresh</p>
<div id="notificationAll">


</div>

<br>
<hr>
<br>
<p>Real Time</p>
<div id="notificationReal">


</div>

<script src="webjars/jquery/3.3.1-1/jquery.min.js"></script>
<script>
    if (typeof(EventSource) !== "undefined") {

        var lastDate = null;
        var notifications = new Map();
        var realTimeNotifications = new Map();


        var realTime = function (notifications, notification) {
            if (notification.state != 0) {
                notifications.delete(notification.id);
            } else {
                notifications.set(notification.id, notification);
            }
        }

        var updatePanel = function (notifications, div) {

            var array = Array.from(notifications).sort(function (a, b) {
                var first = a[1].modified;
                var second = b[1].modified;
                if (first < second) {
                    return -1;
                } else if (second < first) {
                    return 1;
                } else {
                    return 0;
                }
            });
            var l = array.length;
            document.getElementById(div).innerHTML = "";
            for (var i = 0; i < l; i++) {
                document.getElementById(div).innerHTML += array[i][1].id + "<br>";
            }
        }

        var partialShow = function (notification) {
            if (notification == null)
                return;

            $.get('/notifications',
                {ApiKey: "7", channel: notification.channel, after: lastDate},
                function (returnedData) {
                    console.log(returnedData);
                    if (Array.isArray(returnedData)) {
                        var length = returnedData.length;
                        for (var i = 0; i < length; i++) {
                            realTime(notifications, notification);
                        }
                        updatePanel(notifications, "notification");
                        var length = returnedData.length;
                        if (length > 0) {
                            lastDate = new Date(returnedData[0].modified).getTime();
                        }
                    }
                }
            );
        }

        var showNotifications = function (channelName, fresh) {
            if (channelName != null) {
                $.get('/notifications',
                    {ApiKey: "7", channel: channelName},
                    function (returnedData) {
                        console.log(returnedData);
                        if (Array.isArray(returnedData)) {
                            var length = returnedData.length;
                            document.getElementById("notificationAll").innerHTML = "";
                            if (fresh) {
                                realTimeNotifications = new Map();
                            }
                            for (var i = 0; i < length; i++) {
                                if (fresh) {
                                    realTimeNotifications.set(returnedData[i].id, returnedData[i]);
                                }
                                document.getElementById("notificationAll").innerHTML += returnedData[i].id + "<br>";
                            }
                            if(fresh) {
                                updatePanel( realTimeNotifications, "notificationReal");
                            }
                        }
                    }
                );
            }
        };


        var source = new EventSource("/subscribe?ApiKey=7&channel=tur.deneme");
        source.onopen = function () {
            console.log("Connection is open.");
            showNotifications("tur.deneme", true);

        }


        source.onmessage = function (event) {
            var data = JSON.parse(event.data);
            document.getElementById("result").innerHTML += data.channel + "<br>";
            partialShow(data);
            showNotifications(data.channel);
            realTime(realTimeNotifications, data);
            updatePanel(realTimeNotifications, "notificationReal");
        };


    } else {
        document.getElementById("result").innerHTML = "Sorry, your browser does not support server-sent events...";
    }


</script>
</body>
</html>